<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Trivia Game</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
</head>
<body>
    <audio id="background-music" autoplay loop>
        <source src="{{ url_for('static', filename='music1.mp3') }}" type="audio/mpeg">
    </audio>
    <div class="container">
        <div class="row justify-content-center mt-3">
            <div class="col-lg-8">
                <div class="card shadow">
                    <div class="card-header bg-primary text-white">
                        <div class="d-flex justify-content-between align-items-center">
                            <h2 class="mb-0">AI Trivia Game</h2>
                            <div>
                                <span class="badge bg-info">Game ID: <span id="game-id-display">{{ game_id }}</span></span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="card-body">
                        <!-- Waiting Lobby -->
                        <div id="waiting-lobby" class="text-center">
                            <h3>Waiting for Players</h3>
                            <p>Share the Game ID with friends to join!</p>
                            <div class="player-list mb-4">
                                <h4>Players:</h4>
                                <ul id="player-list" class="list-group">
                                    <!-- Players will be added here dynamically -->
                                </ul>
                            </div>
                            {% if is_host %}
                            <button id="start-game-btn" class="btn btn-lg btn-success">Start Game</button>
                            {% else %}
                            <p>Waiting for host to start the game...</p>
                            {% endif %}
                        </div>
                        
                        <!-- Topic Selection -->
                        <div id="topic-selection" style="display: none;">
                            <h3>Select a Topic</h3>
                            <p>It's your turn to choose a topic for the trivia question!</p>
                            <div class="mb-3">
                                <input type="text" id="topic-input" class="form-control form-control-lg" placeholder="Enter a topic (e.g., Science, History, Movies)">
                            </div>
                            <div class="d-grid gap-2 d-md-flex justify-content-md-center">
                                <button id="submit-topic-btn" class="btn btn-primary btn-lg">Submit Topic</button>
                                <button id="random-topic-btn" class="btn btn-secondary btn-lg">Random Topic</button>
                            </div>
                        </div>
                        
                        <!-- Question Display -->
                        <div id="question-display" style="display: none;">
                            <div class="text-center mb-4">
                                <span class="badge bg-secondary mb-2">Topic: <span id="topic-display"></span></span>
                                <h3 id="question-text" class="mb-3"></h3>
                                <div class="progress mb-3">
                                    <div id="timer-progress" class="progress-bar bg-danger" role="progressbar" style="width: 100%"></div>
                                </div>
                            </div>
                            
                            <div class="answer-section">
                                <div class="mb-3">
                                    <label class="form-label">Select an Answer:</label>
                                    <div class="list-group">
                                        <button id="option-a" class="list-group-item list-group-item-action">A) <span id="option-a-text"></span></button>
                                        <button id="option-b" class="list-group-item list-group-item-action">B) <span id="option-b-text"></span></button>
                                        <button id="option-c" class="list-group-item list-group-item-action">C) <span id="option-c-text"></span></button>
                                        <button id="option-d" class="list-group-item list-group-item-action">D) <span id="option-d-text"></span></button>
                                    </div>
                                </div>
                                <button id="submit-answer-btn" class="btn btn-primary btn-lg">Submit Answer</button>
                            </div>
                            
                            <div class="waiting-for-answers mt-4" style="display: none;">
                                <p>Waiting for other players to answer...</p>
                                <div class="progress">
                                    <div id="answer-progress" class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 0%"></div>
                                </div>
                                <ul id="answered-players" class="list-group mt-2">
                                    <!-- Players who answered will be added here dynamically -->
                                </ul>
                            </div>
                        </div>
                        
                        <!-- Results Display -->
                        <div id="results-display" style="display: none;">
                            <h3 class="text-center mb-4">Round Results</h3>
                            
                            <div class="card mb-4">
                                <div class="card-header bg-info">
                                    <h4 class="mb-0">Correct Answer</h4>
                                </div>
                                <div class="card-body">
                                    <p id="correct-answer" class="lead"></p>
                                    <p id="answer-explanation" class="fst-italic"></p>
                                </div>
                            </div>
                            
                            <div class="card mb-4">
                                <div class="card-header bg-light">
                                    <h4 class="mb-0">Player Answers</h4>
                                </div>
                                <div class="card-body">
                                    <ul id="player-answers" class="list-group">
                                        <!-- Player answers will be added here dynamically -->
                                    </ul>
                                </div>
                            </div>
                            
                            <div id="next-round-info" class="text-center">
                                <p>Next round starting soon...</p>
                                <p>It will be <span id="next-player" class="fw-bold"></span>'s turn to select a topic.</p>
                                <div class="progress">
                                    <div id="next-round-progress" class="progress-bar progress-bar-striped progress-bar-animated bg-success" role="progressbar" style="width: 0%"></div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Scoreboard (always visible once game starts) -->
                        <div id="scoreboard" class="mt-4" style="display: none;">
                            <h4>Scoreboard</h4>
                            <table class="table table-striped">
                                <thead>
                                    <tr>
                                        <th>Player</th>
                                        <th>Score</th>
                                    </tr>
                                </thead>
                                <tbody id="scores-table-body">
                                    <!-- Scores will be added here dynamically -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Leave Game Button -->
    <div id="leave-game-container" class="text-center mb-3" style="display: none;">
        <button id="leave-game-btn" class="btn btn-danger btn-lg">Leave Game</button>
    </div>

    <!-- Music Icon and Controls -->
    <div id="music-icon">
        <i class="fas fa-music"></i>
    </div>
    <div id="music-controls">
        <select id="music-select">
            <option value="music1.mp3">Music 1</option>
            <option value="music2.mp3">Music 2</option>
            <option value="music3.mp3">Music 3</option>
        </select>
        <input type="range" id="volume-control" min="0" max="1" step="0.1" value="1">
        <button id="mute-toggle">🔊</button>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Game variables
        const gameId = "{{ game_id }}";
        const username = "{{ username }}";
        const isHost = {{ 'true' if is_host else 'false' }};
        let socket;
        let answeredPlayers = new Set();
        let timerInterval;
        let timeLeft = 30;
        let selectedAnswer = null;
        const emojis = ['😀', '😂', '🤓', '😎', '🎉', '🚀', '🌟', '🍕', '🎵', '🐱'];
        
        // DOM elements
        const waitingLobby = document.getElementById('waiting-lobby');
        const topicSelection = document.getElementById('topic-selection');
        const questionDisplay = document.getElementById('question-display');
        const resultsDisplay = document.getElementById('results-display');
        const scoreboard = document.getElementById('scoreboard');
        const leaveGameContainer = document.getElementById('leave-game-container');
        const timerProgress = document.getElementById('timer-progress');
        const musicIcon = document.getElementById('music-icon');
        const musicControls = document.getElementById('music-controls');
        const topicInput = document.getElementById('topic-input');
        const triviaFacts = document.createElement('div');
        triviaFacts.id = 'trivia-facts';

        // Connect to Socket.IO
        document.addEventListener('DOMContentLoaded', function() {
            connectToSocket();
            setupEventListeners();
            document.querySelector('.card-body').prepend(triviaFacts);
        });
        
        function connectToSocket() {
            socket = io();
            
            socket.on('connect', function() {
                console.log('Connected to server');
                socket.emit('join_game_room', {
                    game_id: gameId,
                    username: username
                });
            });
            
            socket.on('player_joined', function(data) {
                updatePlayerList(data.players);
            });
            
            socket.on('player_left', function(data) {
                updatePlayerList(data.players);
            });
            
            socket.on('game_started', function(data) {
                startGame(data);
            });
            
            socket.on('question_ready', function(data) {
                showQuestion(data);
            });
            
            socket.on('player_answered', function(data) {
                playerAnswered(data.username);
            });
            
            socket.on('round_results', function(data) {
                showResults(data);
            });

            socket.on('random_topic_selected', function(data) {
                document.getElementById('topic-input').value = data.topic;
            });
        }
        
        function setupEventListeners() {
            // Start game button
            const startGameBtn = document.getElementById('start-game-btn');
            if (startGameBtn) {
                startGameBtn.addEventListener('click', function() {
                    socket.emit('start_game', {
                        game_id: gameId,
                        username: username
                    });
                });
            }
            
            // Submit topic button
            document.getElementById('submit-topic-btn').addEventListener('click', function() {
                const topic = document.getElementById('topic-input').value.trim();
                if (topic) {
                    socket.emit('select_topic', {
                        game_id: gameId,
                        username: username,
                        topic: topic
                    });
                    
                    topicSelection.style.display = 'none';
                    const loadingDiv = document.createElement('div');
                    loadingDiv.id = 'loading-question';
                    loadingDiv.className = 'text-center my-5';
                    loadingDiv.innerHTML = `
                        <h3>Generating Question...</h3>
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                    `;
                    document.querySelector('.card-body').appendChild(loadingDiv);
                }
            });

            // Random topic button
            document.getElementById('random-topic-btn').addEventListener('click', function() {
                socket.emit('select_topic', {
                    game_id: gameId,
                    username: username,
                    topic: ''
                });
                
                topicSelection.style.display = 'none';
                const loadingDiv = document.createElement('div');
                loadingDiv.id = 'loading-question';
                loadingDiv.className = 'text-center my-5';
                loadingDiv.innerHTML = `
                    <h3>Generating Question...</h3>
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                `;
                document.querySelector('.card-body').appendChild(loadingDiv);
            });
            
            // Answer selection buttons
            document.getElementById('option-a').addEventListener('click', function() {
                selectAnswer('A');
            });
            document.getElementById('option-b').addEventListener('click', function() {
                selectAnswer('B');
            });
            document.getElementById('option-c').addEventListener('click', function() {
                selectAnswer('C');
            });
            document.getElementById('option-d').addEventListener('click', function() {
                selectAnswer('D');
            });

            // Submit answer button
            document.getElementById('submit-answer-btn').addEventListener('click', function() {
                if (selectedAnswer) {
                    socket.emit('submit_answer', {
                        game_id: gameId,
                        username: username,
                        answer: selectedAnswer
                    });
                    
                    disableAnswerButtons();
                    document.getElementById('submit-answer-btn').disabled = true;
                    document.querySelector('.waiting-for-answers').style.display = 'block';
                }
            });

            // Leave game button
            document.getElementById('leave-game-btn').addEventListener('click', function() {
                window.location.href = '/';
            });

            // Music icon toggle
            musicIcon.addEventListener('click', function() {
                musicControls.classList.toggle('show');
            });
        }
        
        function selectAnswer(answer) {
            selectedAnswer = answer;
            document.querySelectorAll('.list-group-item').forEach(button => {
                button.classList.remove('active');
            });
            document.getElementById(`option-${answer.toLowerCase()}`).classList.add('active');
        }

        function disableAnswerButtons() {
            document.querySelectorAll('.list-group-item').forEach(button => {
                button.disabled = true;
            });
        }

        function updatePlayerList(players) {
            const playerList = document.getElementById('player-list');
            playerList.innerHTML = '';
            
            players.forEach(player => {
                const li = document.createElement('li');
                li.className = 'list-group-item d-flex justify-content-between align-items-center';
                li.textContent = player;
                
                if (player === username) {
                    li.className += ' list-group-item-primary';
                    li.innerHTML += ' <span class="badge bg-primary">You</span>';
                }
                
                playerList.appendChild(li);
            });
        }
        
        function startGame(data) {
            waitingLobby.style.display = 'none';
            scoreboard.style.display = 'block';
            leaveGameContainer.style.display = 'block';
            updateScoreboard(data.scores);
            
            if (data.current_player === username) {
                topicSelection.style.display = 'block';
                topicInput.value = ''; // Clear topic input
            } else {
                startTriviaFacts();
                const waitingDiv = document.createElement('div');
                waitingDiv.id = 'waiting-for-topic';
                waitingDiv.className = 'text-center my-5';
                waitingDiv.innerHTML = `
                    <h3>Waiting for ${data.current_player} to select a topic...</h3>
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                `;
                document.querySelector('.card-body').appendChild(waitingDiv);
            }
        }
        
        function showQuestion(data) {
            const loadingEl = document.getElementById('loading-question');
            if (loadingEl) loadingEl.remove();
            
            const waitingEl = document.getElementById('waiting-for-topic');
            if (waitingEl) waitingEl.remove();
            triviaFacts.style.display = 'none';
            
            questionDisplay.style.display = 'block';
            document.getElementById('topic-display').textContent = data.topic;
            document.getElementById('question-text').textContent = data.question;
            
            document.getElementById('option-a-text').textContent = data.options[0];
            document.getElementById('option-b-text').textContent = data.options[1];
            document.getElementById('option-c-text').textContent = data.options[2];
            document.getElementById('option-d-text').textContent = data.options[3];
            
            selectedAnswer = null;
            document.querySelectorAll('.list-group-item').forEach(button => {
                button.classList.remove('active');
                button.disabled = false;
            });
            document.getElementById('submit-answer-btn').disabled = false;
            document.querySelector('.waiting-for-answers').style.display = 'none';
            
            answeredPlayers.clear();
            document.getElementById('answered-players').innerHTML = '';
            document.getElementById('answer-progress').style.width = '0%';
            
            startTimer();
        }
        
        function startTimer() {
            timeLeft = 30;
            timerProgress.style.width = '100%';
            clearInterval(timerInterval);
            
            timerInterval = setInterval(() => {
                timeLeft--;
                timerProgress.style.width = `${(timeLeft / 30) * 100}%`;
                
                if (timeLeft <= 0) {
                    clearInterval(timerInterval);
                    if (selectedAnswer) {
                        document.getElementById('submit-answer-btn').click();
                    } else {
                        socket.emit('submit_answer', {
                            game_id: gameId,
                            username: username,
                            answer: null
                        });
                    }
                }
            }, 1000);
        }
        
        function playerAnswered(playerName) {
            answeredPlayers.add(playerName);
            
            const answeredPlayersList = document.getElementById('answered-players');
            answeredPlayersList.innerHTML = '';
            
            Array.from(answeredPlayers).forEach(player => {
                const li = document.createElement('li');
                li.className = 'list-group-item';
                li.textContent = player;
                answeredPlayersList.appendChild(li);
            });
            
            const playersCount = document.getElementById('player-list').childElementCount;
            const progress = (answeredPlayers.size / playersCount) * 100;
            document.getElementById('answer-progress').style.width = progress + '%';
        }
        
        function showResults(data) {
            questionDisplay.style.display = 'none';
            resultsDisplay.style.display = 'block';
            
            document.getElementById('correct-answer').textContent = data.correct_answer;
            document.getElementById('answer-explanation').textContent = data.explanation;
            
            const playerAnswersList = document.getElementById('player-answers');
            playerAnswersList.innerHTML = '';
            
            Object.entries(data.player_answers).forEach(([player, answer]) => {
                const li = document.createElement('li');
                li.className = 'list-group-item';
                
                if (data.correct_players.includes(player)) {
                    li.className += ' list-group-item-success';
                }
                
                if (player === username) {
                    li.className += ' fw-bold';
                }
                
                li.innerHTML = `<span>${player}:</span> <span>${answer || 'No answer submitted'}</span>`;
                playerAnswersList.appendChild(li);
            });
            
            document.getElementById('next-player').textContent = data.next_player;
            updateScoreboard(data.scores);
            startNextRoundCountdown(data.next_player);
        }
        
        function updateScoreboard(scores) {
            const scoresTableBody = document.getElementById('scores-table-body');
            scoresTableBody.innerHTML = '';
            
            const sortedScores = Object.entries(scores).sort((a, b) => b[1] - a[1]);
            const emojiMap = {};
            sortedScores.forEach(([player], index) => {
                if (!emojiMap[player]) {
                    emojiMap[player] = emojis[Math.floor(Math.random() * emojis.length)];
                }
            });
            
            sortedScores.forEach(([player, score], index) => {
                const tr = document.createElement('tr');
                
                if (player === username) {
                    tr.className = 'table-primary';
                }
                
                tr.innerHTML = `
                    <td><span class="player-emoji">${emojiMap[player]}</span> ${player}</td>
                    <td>${score}</td>
                `;
                
                scoresTableBody.appendChild(tr);
            });
        }
        
        function startNextRoundCountdown(nextPlayer) {
            let progress = 0;
            const progressBar = document.getElementById('next-round-progress');
            
            progressBar.style.width = '0%';
            progressBar.style.transition = 'width 10s linear';
            
            setTimeout(() => {
                progressBar.style.width = '100%';
            }, 100);
            
            setTimeout(() => {
                progressBar.style.width = '0%';
                progressBar.style.transition = 'none';
                resultsDisplay.style.display = 'none';
            
                if (nextPlayer === username) {
                    topicSelection.style.display = 'block';
                    topicInput.value = ''; // Clear topic input
                } else {
                    startTriviaFacts();
                    const waitingDiv = document.createElement('div');
                    waitingDiv.id = 'waiting-for-topic';
                    waitingDiv.className = 'text-center my-5';
                    waitingDiv.innerHTML = `
                        <h3>Waiting for ${nextPlayer} to select a topic...</h3>
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                    `;
                    document.querySelector('.card-body').appendChild(waitingDiv);
                }
            }, 10000);
        }

        // Scrolling Trivia Facts
        const triviaFactsList = [
            "The shortest war in history lasted 38 minutes.",
            "Honey never spoils; archaeologists found edible honey in ancient Egyptian tombs.",
            "Octopuses have three hearts.",
            "The Eiffel Tower can be 15 cm taller in summer due to thermal expansion.",
            "Bananas are berries, but strawberries aren't!"
        ];

        function startTriviaFacts() {
            triviaFacts.style.display = 'block';
            let index = 0;
            setInterval(() => {
                triviaFacts.innerHTML = `<span>${triviaFactsList[index]}</span>`;
                index = (index + 1) % triviaFactsList.length;
            }, 3000); // Change fact every 3 seconds
        }

        // Music Player Controls
        const audioElement = document.getElementById("background-music");
        const musicSelect = document.getElementById("music-select");
        const volumeControl = document.getElementById("volume-control");
        const muteToggle = document.getElementById("mute-toggle");

        musicSelect.addEventListener("change", function() {
            const newSrc = "{{ url_for('static', filename='') }}" + this.value;
            audioElement.src = newSrc;
            audioElement.play();
        });

        volumeControl.addEventListener("input", function() {
            audioElement.volume = this.value;
        });

        muteToggle.addEventListener("click", function() {
            audioElement.muted = !audioElement.muted;
            this.classList.toggle("muted", audioElement.muted);
            this.textContent = audioElement.muted ? "🔇" : "🔊";
        });
    </script>
</body>
</html>